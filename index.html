<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>대학별 활동 히트맵 - Themoonlight</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useCallback, useMemo, useEffect } = React;
    const API_URL = 'https://script.google.com/macros/s/AKfycbzQYpAkNsl1u44t80SCu584Ms7zfZAQ92uttM2VFWYtbUMHbTojhvq_TZT_0gEgxY05/exec';
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1NuTdFE4z58q599xCByoUP6oLejwCurvjzgztwSSWMAM/edit';

    function App() {
      const [rawRecords, setRawRecords] = useState([]);
      const [universities, setUniversities] = useState([]);
      const [selectedUniversity, setSelectedUniversity] = useState('all');
      const [hoveredCell, setHoveredCell] = useState(null);
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(true);
      const [lastUpdated, setLastUpdated] = useState(null);

      const parseData = useCallback(function(jsonData) {
        const records = [];
        const univSet = new Set();
        for (let i = 0; i < jsonData.length; i++) {
          const item = jsonData[i];
          const timeStr = String(item.time || '');
          const university = String(item.university || '').trim();
          if (!university || !timeStr) continue;
          
          // ISO 8601 형식: 2025-11-25T08:08:45.000Z
          let match = timeStr.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
          if (match) {
            const dateObj = new Date(timeStr);
            // UTC를 KST로 변환 (+9시간)
            const kstDate = new Date(dateObj.getTime() + (9 * 60 * 60 * 1000));
            records.push({ 
              year: kstDate.getFullYear(), 
              month: kstDate.getMonth() + 1, 
              day: kstDate.getDate(), 
              hour: kstDate.getHours(), 
              date: new Date(kstDate.getFullYear(), kstDate.getMonth(), kstDate.getDate()), 
              university: university 
            });
            univSet.add(university);
            continue;
          }
          
          // MM/DD/YYYY HH:MM:SS 형식
          match = timeStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):/);
          if (match) {
            records.push({ 
              year: parseInt(match[3]), 
              month: parseInt(match[1]), 
              day: parseInt(match[2]), 
              hour: parseInt(match[4]), 
              date: new Date(match[3], match[1] - 1, match[2]), 
              university: university 
            });
            univSet.add(university);
            continue;
          }
          
          // YYYY-MM-DD HH:MM:SS 형식
          match = timeStr.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\s+(\d{1,2}):/);
          if (match) {
            records.push({ 
              year: parseInt(match[1]), 
              month: parseInt(match[2]), 
              day: parseInt(match[3]), 
              hour: parseInt(match[4]), 
              date: new Date(match[1], match[2] - 1, match[3]), 
              university: university 
            });
            univSet.add(university);
          }
        }
        if (records.length === 0) throw new Error('유효한 데이터를 찾을 수 없습니다.');
        return { records: records, universities: Array.from(univSet).sort() };
      }, []);

      const loadFromGoogleSheets = useCallback(function() {
        setLoading(true);
        setError(null);
        fetch(API_URL)
          .then(function(response) {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
          })
          .then(function(jsonData) {
            const result = parseData(jsonData);
            setRawRecords(result.records);
            setUniversities(result.universities);
            setSelectedUniversity('all');
            setLastUpdated(new Date());
            setLoading(false);
          })
          .catch(function(err) {
            setError('데이터 로드 실패: ' + err.message);
            setRawRecords([]);
            setUniversities([]);
            setLoading(false);
          });
      }, [parseData]);

      useEffect(function() { 
        loadFromGoogleSheets(); 
      }, [loadFromGoogleSheets]);

      const filteredRecords = useMemo(function() {
        if (selectedUniversity === 'all') return rawRecords;
        return rawRecords.filter(function(r) { return r.university === selectedUniversity; });
      }, [rawRecords, selectedUniversity]);

      const data = useMemo(function() {
        if (filteredRecords.length === 0) return null;
        const sortedRecords = filteredRecords.slice().sort(function(a, b) { return a.date - b.date; });
        const startDate = sortedRecords[0].date;
        const endDate = sortedRecords[sortedRecords.length - 1].date;
        const dates = [];
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        const currentDate = new Date(startDate);
        while (currentDate <= endDate) {
          dates.push({ 
            key: (currentDate.getMonth() + 1) + '/' + currentDate.getDate(), 
            dayName: dayNames[currentDate.getDay()], 
            fullDate: new Date(currentDate) 
          });
          currentDate.setDate(currentDate.getDate() + 1);
        }
        const matrix = {};
        const dailyTotals = {};
        dates.forEach(function(d) { 
          matrix[d.key] = {}; 
          dailyTotals[d.key] = 0; 
          for (let h = 0; h < 24; h++) matrix[d.key][h] = 0; 
        });
        filteredRecords.forEach(function(record) { 
          const dateKey = record.month + '/' + record.day; 
          if (matrix[dateKey]) { 
            matrix[dateKey][record.hour]++; 
            dailyTotals[dateKey]++; 
          } 
        });
        let maxHourlyCount = 0;
        dates.forEach(function(d) { 
          for (let h = 0; h < 24; h++) {
            if (matrix[d.key][h] > maxHourlyCount) maxHourlyCount = matrix[d.key][h]; 
          }
        });
        const maxDailyTotal = Math.max.apply(null, Object.values(dailyTotals));
        return { 
          dates: dates, 
          matrix: matrix, 
          dailyTotals: dailyTotals, 
          maxHourlyCount: maxHourlyCount, 
          maxDailyTotal: maxDailyTotal, 
          totalCount: filteredRecords.length, 
          startDate: startDate, 
          endDate: endDate 
        };
      }, [filteredRecords]);

      const universityStats = useMemo(function() {
        const stats = {};
        rawRecords.forEach(function(r) { 
          stats[r.university] = (stats[r.university] || 0) + 1; 
        });
        return Object.entries(stats)
          .sort(function(a, b) { return b[1] - a[1]; })
          .map(function(entry) { return { name: entry[0], count: entry[1] }; });
      }, [rawRecords]);

      function getColor(count, maxCount) {
        if (count === 0 || maxCount === 0) return 'bg-slate-800';
        const intensity = count / maxCount;
        if (intensity > 0.8) return 'bg-orange-500';
        if (intensity > 0.6) return 'bg-orange-600';
        if (intensity > 0.4) return 'bg-blue-500';
        if (intensity > 0.2) return 'bg-blue-600';
        return 'bg-blue-800';
      }

      function formatDate(date) {
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return date.getFullYear() + '.' + m + '.' + d;
      }

      function formatTime(date) {
        return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
      }

      function handleUniversityClick(name) {
        if (selectedUniversity === name) {
          setSelectedUniversity('all');
        } else {
          setSelectedUniversity(name);
        }
      }

      function renderHourRow(hour) {
        return (
          <div key={hour} className="flex items-center">
            <div className="w-10 text-right pr-1 text-slate-500 text-xs">{hour}시</div>
            {data.dates.map(function(d) {
              const count = data.matrix[d.key][hour];
              return (
                <div 
                  key={d.key + '-' + hour} 
                  className={'w-14 h-5 m-0.5 rounded cursor-pointer transition-all hover:ring-2 hover:ring-white/50 flex items-center justify-center ' + getColor(count, data.maxHourlyCount)}
                  onMouseEnter={function() { setHoveredCell({ date: d.key, hour: hour, count: count }); }}
                  onMouseLeave={function() { setHoveredCell(null); }}
                >
                  {count > 0 && <span className="text-xs text-white/80">{count}</span>}
                </div>
              );
            })}
          </div>
        );
      }

      const hours = [];
      for (let h = 0; h < 24; h++) hours.push(h);

      return (
        <div className="min-h-screen bg-slate-900 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center justify-between mb-2">
              <h1 className="text-2xl font-bold text-white">대학별 활동 히트맵</h1>
              {lastUpdated && <span className="text-slate-500 text-sm">마지막 업데이트: {formatTime(lastUpdated)}</span>}
            </div>
            <div className="mb-6 flex flex-wrap items-center gap-3">
              <button onClick={loadFromGoogleSheets} disabled={loading} className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-green-800 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
                {loading ? '로딩 중...' : '새로고침'}
              </button>
              {universities.length > 0 && (
                <select value={selectedUniversity} onChange={function(e) { setSelectedUniversity(e.target.value); }} className="px-4 py-2 bg-slate-700 text-white rounded-lg border border-slate-600">
                  <option value="all">전체 대학 ({rawRecords.length}건)</option>
                  {universityStats.map(function(item) { 
                    return <option key={item.name} value={item.name}>{item.name} ({item.count}건)</option>;
                  })}
                </select>
              )}
              <a href={SHEET_URL} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm">시트 열기</a>
            </div>
            {error && <div className="mb-6 p-4 bg-red-900/50 border border-red-500 rounded-lg text-red-200">{error}</div>}
            {loading && rawRecords.length === 0 && (
              <div className="bg-slate-800/50 rounded-2xl p-12 text-center">
                <p className="text-slate-400">Google Sheets에서 데이터 로딩 중...</p>
              </div>
            )}
            {data && (
              <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div className="lg:col-span-3">
                  <p className="text-slate-400 mb-4">
                    {formatDate(data.startDate)} ~ {formatDate(data.endDate)}
                    {selectedUniversity !== 'all' && (' | ' + selectedUniversity)} 
                    (총 {data.totalCount.toLocaleString()}건)
                  </p>
                  <div className="flex items-center gap-2 mb-4 text-sm text-slate-400">
                    <span>적음</span>
                    <div className="flex gap-1">
                      <div className="w-4 h-4 rounded bg-slate-800"></div>
                      <div className="w-4 h-4 rounded bg-blue-800"></div>
                      <div className="w-4 h-4 rounded bg-blue-600"></div>
                      <div className="w-4 h-4 rounded bg-blue-500"></div>
                      <div className="w-4 h-4 rounded bg-orange-600"></div>
                      <div className="w-4 h-4 rounded bg-orange-500"></div>
                    </div>
                    <span>많음</span>
                    {hoveredCell && <span className="ml-4 text-white">{hoveredCell.date} {hoveredCell.hour}시: {hoveredCell.count}건</span>}
                  </div>
                  <div className="bg-slate-800/50 rounded-2xl p-4 overflow-x-auto">
                    <div className="min-w-max">
                      <div className="flex">
                        <div className="w-10"></div>
                        {data.dates.map(function(d) { 
                          return (
                            <div key={d.key} className="w-14 text-center text-slate-300 text-xs font-medium pb-1">
                              {d.key}<br/><span className="text-slate-500">({d.dayName})</span>
                            </div>
                          );
                        })}
                      </div>
                      <div className="flex items-center mb-1">
                        <div className="w-10 text-right pr-1 text-slate-400 text-xs font-bold">합계</div>
                        {data.dates.map(function(d) { 
                          const total = data.dailyTotals[d.key]; 
                          const isMax = total === data.maxDailyTotal && total > 0; 
                          return (
                            <div key={'total-' + d.key} className={'w-14 h-6 m-0.5 rounded flex items-center justify-center font-bold text-xs ' + (isMax ? 'bg-orange-500 text-white' : 'bg-slate-700 text-slate-200')}>
                              {total}
                            </div>
                          );
                        })}
                      </div>
                      <div className="flex items-center mb-1">
                        <div className="w-10"></div>
                        <div className="flex-1 h-px bg-slate-600"></div>
                      </div>
                      {hours.map(function(hour) { return renderHourRow(hour); })}
                    </div>
                  </div>
                  <div className="mt-4 grid grid-cols-4 gap-3">
                    <div className="bg-slate-800 rounded-xl p-3">
                      <p className="text-slate-400 text-xs">총 건수</p>
                      <p className="text-lg font-bold text-white">{data.totalCount.toLocaleString()}</p>
                    </div>
                    <div className="bg-slate-800 rounded-xl p-3">
                      <p className="text-slate-400 text-xs">기간</p>
                      <p className="text-lg font-bold text-white">{data.dates.length}일</p>
                    </div>
                    <div className="bg-slate-800 rounded-xl p-3">
                      <p className="text-slate-400 text-xs">일 평균</p>
                      <p className="text-lg font-bold text-blue-400">{(data.totalCount / data.dates.length).toFixed(1)}</p>
                    </div>
                    <div className="bg-slate-800 rounded-xl p-3">
                      <p className="text-slate-400 text-xs">최대 일간</p>
                      <p className="text-lg font-bold text-orange-500">{data.maxDailyTotal}</p>
                    </div>
                  </div>
                </div>
                <div className="lg:col-span-1">
                  <div className="bg-slate-800/50 rounded-2xl p-4">
                    <h2 className="text-white font-bold mb-3">대학별 현황</h2>
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {universityStats.map(function(item, index) { 
                        const percentage = (item.count / rawRecords.length * 100).toFixed(1); 
                        const isSelected = selectedUniversity === item.name; 
                        return (
                          <div 
                            key={item.name} 
                            onClick={function() { handleUniversityClick(item.name); }} 
                            className={'p-2 rounded-lg cursor-pointer transition-all ' + (isSelected ? 'bg-blue-600 ring-2 ring-blue-400' : 'bg-slate-700 hover:bg-slate-600')}
                          >
                            <div className="flex justify-between items-center">
                              <span className="text-white text-sm font-medium truncate">{index + 1}. {item.name}</span>
                              <span className="text-slate-300 text-sm ml-2">{item.count}</span>
                            </div>
                            <div className="mt-1 h-1.5 bg-slate-600 rounded-full overflow-hidden">
                              <div className={'h-full rounded-full ' + (isSelected ? 'bg-blue-300' : 'bg-blue-500')} style={{ width: percentage + '%' }}></div>
                            </div>
                            <p className="text-slate-400 text-xs mt-1">{percentage}%</p>
                          </div>
                        );
                      })}
                    </div>
                    {selectedUniversity !== 'all' && (
                      <button onClick={function() { setSelectedUniversity('all'); }} className="mt-3 w-full py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm">
                        필터 초기화
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )}
            <div className="mt-8 text-center text-slate-600 text-sm">Powered by Themoonlight</div>
          </div>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
