<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>대학별 활동 히트맵 - Themoonlight</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useCallback, useMemo, useEffect } = React;
    const API_URL = 'https://script.google.com/macros/s/AKfycbzQYpAkNsl1u44t80SCu584Ms7zfZAQ92uttM2VFWYtbUMHbTojhvq_TZT_0gEgxY05/exec';
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1NuTdFE4z58q599xCByoUP6oLejwCurvjzgztwSSWMAM/edit';

    function App() {
      const [rawRecords, setRawRecords] = useState([]);
      const [universities, setUniversities] = useState([]);
      const [selectedUniversity, setSelectedUniversity] = useState('all');
      const [hoveredCell, setHoveredCell] = useState(null);
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(true);
      const [lastUpdated, setLastUpdated] = useState(null);

      const parseData = useCallback((jsonData) => {
        const records = [];
        const univSet = new Set();
        for (const item of jsonData) {
          const timeStr = String(item.time || '');
          const university = String(item.university || '').trim();
          if (!university || !timeStr) continue;
          let match = timeStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):/);
          if (match) {
            const [, month, day, year, hour] = match;
            records.push({ year: parseInt(year), month: parseInt(month), day: parseInt(day), hour: parseInt(hour), date: new Date(year, month - 1, day), university });
            univSet.add(university);
            continue;
          }
          match = timeStr.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\s+(\d{1,2}):/);
          if (match) {
            const [, year, month, day, hour] = match;
            records.push({ year: parseInt(year), month: parseInt(month), day: parseInt(day), hour: parseInt(hour), date: new Date(year, month - 1, day), university });
            univSet.add(university);
          }
        }
        if (records.length === 0) throw new Error('유효한 데이터를 찾을 수 없습니다.');
        return { records, universities: Array.from(univSet).sort() };
      }, []);

      const loadFromGoogleSheets = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(API_URL);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const jsonData = await response.json();
          const { records, universities: univs } = parseData(jsonData);
          setRawRecords(records);
          setUniversities(univs);
          setSelectedUniversity('all');
          setLastUpdated(new Date());
        } catch (err) {
          setError(`데이터 로드 실패: ${err.message}`);
          setRawRecords([]);
          setUniversities([]);
        } finally {
          setLoading(false);
        }
      }, [parseData]);

      useEffect(() => { loadFromGoogleSheets(); }, [loadFromGoogleSheets]);

      const filteredRecords = useMemo(() => {
        if (selectedUniversity === 'all') return rawRecords;
        return rawRecords.filter(r => r.university === selectedUniversity);
      }, [rawRecords, selectedUniversity]);

      const data = useMemo(() => {
        if (filteredRecords.length === 0) return null;
        const sortedRecords = [...filteredRecords].sort((a, b) => a.date - b.date);
        const startDate = sortedRecords[0].date;
        const endDate = sortedRecords[sortedRecords.length - 1].date;
        const dates = [];
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        const currentDate = new Date(startDate);
        while (currentDate <= endDate) {
          dates.push({ key: `${currentDate.getMonth() + 1}/${currentDate.getDate()}`, dayName: dayNames[currentDate.getDay()], fullDate: new Date(currentDate) });
          currentDate.setDate(currentDate.getDate() + 1);
        }
        const matrix = {};
        const dailyTotals = {};
        dates.forEach(d => { matrix[d.key] = {}; dailyTotals[d.key] = 0; for (let h = 0; h < 24; h++) matrix[d.key][h] = 0; });
        filteredRecords.forEach(record => { const dateKey = `${record.month}/${record.day}`; if (matrix[dateKey]) { matrix[dateKey][record.hour]++; dailyTotals[dateKey]++; } });
        let maxHourlyCount = 0;
        dates.forEach(d => { for (let h = 0; h < 24; h++) if (matrix[d.key][h] > maxHourlyCount) maxHourlyCount = matrix[d.key][h]; });
        const maxDailyTotal = Math.max(...Object.values(dailyTotals));
        return { dates, matrix, dailyTotals, maxHourlyCount, maxDailyTotal, totalCount: filteredRecords.length, startDate, endDate };
      }, [filteredRecords]);
